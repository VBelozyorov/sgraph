<!DOCTYPE html>

<!--

857913222632-jqf7gvhgheqkitu9189iib7svv21d2rs.apps.googleusercontent.com
8seZ9bAk15y3EIyzFsPGPjj9

-->

<html>
    <head>
        <meta charset='utf-8'>
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
        <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
        <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
        <!--[if lt IE 9]>
        <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <title>Sandbox graph</title>

        <script src="https://raw.githubusercontent.com/anvaka/VivaGraphJS/master/dist/vivagraph.min.js"></script>
        <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>

        <style type='text/css'>
            #graphConainer {
                position: absolute;
                /*top: 2em;*/
                width: 100%;
                height: 100%;
            }
            #graphConainer > svg {
                width: 100%;
                height: 100%;
            }
        </style>
    </head>

    <body onload="onLoad()" style="background-color: black;">
        <div id='graphConainer'></div>

<!--        <div id="authorize-div" style="">
            <span>Authorize access to Google Sheets API</span>
            Button for the user to click to initiate auth sequence 
            <button id="authorize-button" onclick="handleAuthClick(event)">
                Authorize
            </button>
        </div>
        <pre id="output"></pre>-->

        <script type = 'text/javascript' >
            var CLIENT_ID = '857913222632-jqf7gvhgheqkitu9189iib7svv21d2rs.apps.googleusercontent.com';
            var SCOPES = ["https://www.googleapis.com/auth/spreadsheets.readonly"];


            var nodeWidth = 100;
            var nodeHeight = 20;
            var nodeColor = '#00a233';

            document.addEventListener('graph-loaded', buildGraph, false);

            function buildGraph() {
                var graph = Viva.Graph.graph();
                var layout = Viva.Graph.Layout.forceDirected(graph, {
                    springLength: 350,
                    springCoeff: 0.00001,
                    dragCoeff: 0.003,
                    gravity: -0.8
                });
                var graphics = Viva.Graph.View.svgGraphics();
                graphics.node(function (node) {
                    var ui = Viva.Graph.svg('g'),
                            // Create SVG text element with user id as content
                            svgText = Viva.Graph.svg('text')
                            .attr('y', '+15px')
                            .attr('x', '+3px')
                            .text(node.id),
                            rect = Viva.Graph.svg('rect')
                            .attr('width', nodeWidth)
                            .attr('height', nodeHeight)
                            .attr('fill', node.data ? node.data : nodeColor);
                    ui.append(rect);
                    ui.append(svgText);
                    return ui;
                }).placeNode(function (nodeUI, pos) {
                    // 'g' element doesn't have convenient (x,y) attributes, instead
                    // we have to deal with transforms: http://www.w3.org/TR/SVG/coords.html#SVGGlobalTransformAttribute
                    nodeUI.attr('transform',
                            'translate(' +
                            (pos.x - nodeWidth) + ',' + (pos.y - nodeHeight) +
                            ')');
                });
                var renderer = Viva.Graph.View.renderer(graph,
                        {
                            layout: layout,
                            graphics: graphics,
                            container: document.getElementById('graphConainer'),
                            renderLinks: true
                        });
                renderer.run(50);

                window.vgraph = graph;

                addNodes(graph, window.nodes);
                addLinks(graph, window.links);

                l = layout;
            }

            function addNodes(graph, nodes) {

                var addInterval = setInterval(function () {
                    graph.beginUpdate();

                    for (var i in nodes) {
                        graph.addNode(nodes[i]);
                    }
                    
                    graph.endUpdate();
                }, 100);
            }

            function addLinks(graph, links) {
                graph.beginUpdate();

                for (var i in links) {
                    graph.addLink(links[i][0], links[i][1]);
                }

                graph.endUpdate();
            }

            function onLoad() {

                //authorize

                window.nodes = [];
                window.links = [];

                checkAuth();

                
            }

            /******************************************************************/

            /**
             * Check if current user has authorized this application.
             */
            function checkAuth() {
                gapi.auth.authorize(
                        {
                            'client_id': CLIENT_ID,
                            'scope': SCOPES.join(' '),
                            'immediate': true
                        }, handleAuthResult);
            }

            /**
             * Handle response from authorization server.
             *
             * @param {Object} authResult Authorization result.
             */
            function handleAuthResult(authResult) {
                if (authResult && !authResult.error) {
                    loadSheetsApi();
                } else {
                    handleAuthClick(null);
                }
            }

            /**
             * Initiate auth flow in response to user clicking authorize button.
             *
             * @param {Event} event Button click event.
             */
            function handleAuthClick(event) {
                gapi.auth.authorize(
                        {client_id: CLIENT_ID, scope: SCOPES, immediate: false},
                        handleAuthResult);
                return false;
            }

            /**
             * Load Sheets API client library.
             */
            function loadSheetsApi() {
                var discoveryUrl =
                        'https://sheets.googleapis.com/$discovery/rest?version=v4';
                gapi.client.load(discoveryUrl).then(loadGraph);
            }


            function loadGraph() {

                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: '1EN0a17MdjYJTwmffPdkVUm7UW2fI3eB-gZaUaLg1QT8',
                    range: 'Граф очных встреч!A3:ZZ100',
                }).then(function (response) {

                    var d = response.result.values;

                    for (var row = 1; row < d.length; row++) {
                        window.nodes.push(d[row][0]);

                        if (row === 0)
                            continue;

                        for (var col = 2; col < d[row].length; col++) {
                            if (d[row][col] === "1")
                                window.links.push([d[0][col], d[row][0]]);
                        }
                    }
                    var event = new Event('graph-loaded');
                    document.dispatchEvent(event);
                }, function (response) {
                    console.error('Error: ' + response.result.error.message);
                });
            }

        </script>
    </body>
</html>
